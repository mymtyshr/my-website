<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>酸の緩衝</title>
<style>
  :root{
    --bg:#ffffff;
    --panel:#ffffff;
    --card:#ffffff;
    --ink:#0f172a;
    --muted:#475569;
    --grid:rgba(0,0,0,.04);
    --accent:#0ea5e9;
    --accent-2:#0284c7;
    --ag:#00ccff;
    --hco3:#10b981;
    --cl:#0f6fa0;
    --na:#d6e2ef;
    --line:rgba(15,23,42,.12);
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    min-height:100vh;
    background:var(--bg);
    color:var(--ink);
    font-family:"IBM Plex Sans JP","Noto Sans JP","Hiragino Sans","Yu Gothic",sans-serif;
    padding:18px;
    display:flex;
    justify-content:center;
  }
  .frame{
    width:min(1100px,100%);
    background:var(--panel);
    border:1px solid var(--line);
    border-radius:18px;
    box-shadow:0 10px 30px rgba(15,23,42,.12);
    padding:18px;
  }
  .top{
    display:flex;
    gap:16px;
    align-items:flex-start;
    flex-wrap:wrap;
  }
  .eyebrow{
    display:inline-flex;
    align-items:center;
    gap:6px;
    padding:6px 10px;
    background:rgba(14,165,233,.12);
    border:1px solid rgba(14,165,233,.25);
    border-radius:999px;
    font-size:12px;
    letter-spacing:.05em;
    color:#0f172a;
    margin:0 0 6px;
  }
  h1{
    margin:0 0 6px;
    font-size:24px;
    letter-spacing:.01em;
  }
  .lead{margin:0 0 10px;color:var(--muted);font-size:14px;line-height:1.6}
  .chips{display:flex;gap:8px;flex-wrap:wrap}
  .chip{
    background:#f8fafc;
    border:1px solid var(--line);
    border-radius:12px;
    padding:6px 10px;
    font-size:12px;
    color:var(--muted);
  }
  .controls{
    margin:16px 0 10px;
    background:var(--card);
    border:1px solid var(--line);
    border-radius:12px;
    padding:12px;
  }
  .ctrl-row{
    display:grid;
    grid-template-columns:1fr auto;
    gap:12px;
    align-items:center;
  }
  label{font-size:13px;color:var(--muted);display:block;margin-bottom:8px}
  .range{
    width:100%;
    accent-color:var(--accent);
    appearance:none;
    height:14px;
    border-radius:999px;
    background:linear-gradient(90deg, rgba(61,208,255,.28), rgba(43,184,228,.18));
    outline:none;
    padding:0 4px;
  }
  .range::-webkit-slider-thumb{
    appearance:none;
    width:18px;height:18px;
    border-radius:50%;
    background:var(--accent);
    border:2px solid #04293d;
    box-shadow:0 0 0 4px rgba(61,208,255,.22);
    cursor:pointer;
  }
  .range::-moz-range-thumb{
    width:18px;height:18px;
    border-radius:50%;
    background:var(--accent);
    border:2px solid #04293d;
    box-shadow:0 0 0 4px rgba(61,208,255,.22);
    cursor:pointer;
  }
  .range::-ms-thumb{
    width:18px;height:18px;
    border-radius:50%;
    background:var(--accent);
    border:2px solid #04293d;
    box-shadow:0 0 0 4px rgba(61,208,255,.22);
    cursor:pointer;
  }
  .range::-webkit-slider-runnable-track{
    height:14px;
    border-radius:999px;
    background:transparent;
  }
  .range::-moz-range-track{
    height:14px;
    border-radius:999px;
    background:transparent;
  }
  .range::-ms-track{
    height:14px;
    border-radius:999px;
    background:transparent;
    border-color:transparent;
    color:transparent;
  }
  .ticks{
    display:flex;
    justify-content:space-between;
    font-size:11px;
    color:var(--muted);
    margin-top:4px;
    letter-spacing:.04em;
  }
  .badge-row{
    display:flex;
    flex-wrap:wrap;
    gap:8px;
    margin-top:8px;
  }
  .pill{
    display:inline-flex;
    align-items:center;
    gap:8px;
    padding:8px 12px;
    background:rgba(61,208,255,.10);
    border:1px solid rgba(61,208,255,.25);
    border-radius:999px;
    font-size:13px;
  }
  .pill strong{font-variant-numeric:tabular-nums;color:var(--ink)}
  .canvas{
    margin-top:12px;
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(300px,1fr));
    gap:14px;
  }
  .chart{
    position:relative;
    background:var(--card);
    border:1px solid var(--line);
    border-radius:14px;
    padding:16px;
    overflow:hidden;
  }
  .grid{
    position:absolute;inset:0;
    background-image:
      linear-gradient(to right, var(--grid) 1px, transparent 1px),
      linear-gradient(to top, var(--grid) 1px, transparent 1px);
    background-size:calc(100%/12) calc(100%/12);
    pointer-events:none;
  }
  .bar-wrap{
    display:flex;
    flex-direction:column;
    gap:18px;
    align-items:stretch;
    margin-top:12px;
  }
  .bar{
    position:relative;
    overflow:visible;
    width:100%;
    min-width:0;
  }
  .bar-title{
    font-size:13px;
    color:var(--muted);
    display:flex;
    justify-content:space-between;
    align-items:center;
  }
  .stack{
    margin-top:10px;
    position:relative;
    background:rgba(255,255,255,.03);
    border:1px solid rgba(255,255,255,.08);
    border-radius:0;
    height:82px;
    display:flex;
    flex-direction:row;
    overflow:visible; /* マーカーや端のバーが見切れないように */
    width:100%;
    max-width:100%;
    min-width:0;
  }
  .seg{
    flex:0 0 0%;
    display:flex;
    align-items:center;
    justify-content:center;
    color:#eaf8ff;
    font-weight:700;
    letter-spacing:.05em;
    position:relative;
    transition:flex-basis 220ms ease, background 200ms ease;
    box-shadow:inset 1px 0 0 rgba(255,255,255,.06);
  }
  .seg:first-child{box-shadow:none;}
  .seg span{filter:drop-shadow(0 1px 0 rgba(0,0,0,.25));font-size:12px;}
  .seg.cl{background:linear-gradient(180deg, #0d7298, #0b5d7b);}
  .seg.hco3{background:linear-gradient(180deg, #36d8c7, #22b7ac);}
  .seg.ag{
    background:rgba(18,214,255,.12);
    color:#0b3245; /* 濃色で視認性アップ */
    font-weight:800;
    border:1px dashed rgba(18,214,255,.7);
    box-shadow:0 0 0 1px rgba(18,214,255,.3) inset;
  }
  .na-stack{
    height:82px;
    margin-top:10px;
    border-radius:0;
    background:#e2e8f0;
    border:1px solid var(--line);
    box-shadow:none;
    position:relative;
    overflow:hidden;
    width:100%;
    max-width:100%;
    min-width:0;
  }
  .na-stack::after{
    content:"Na⁺";
    position:absolute;
    inset:0;
    display:flex;
    align-items:center;
    justify-content:center;
    font-weight:800;
    font-size:20px;
    color:#0a1322;
    text-shadow:0 1px 0 rgba(255,255,255,.6);
  }
  .marker{ display:none; }
  .legend{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(140px,1fr));
    gap:8px;
    margin-top:10px;
    font-size:13px;
  }
  .legend span{font-variant-numeric:tabular-nums}
  .note{margin-top:8px;color:var(--muted);font-size:12px;line-height:1.5}
  .state{
    background:var(--card);
    border:1px solid var(--line);
    border-radius:12px;
    padding:12px;
    display:grid;
    gap:8px;
  }
  .state h3{margin:0;font-size:14px;letter-spacing:.03em}
  .state ul{margin:6px 0 0 14px;padding:0;color:var(--muted);font-size:13px;line-height:1.5}
  @media (max-width:820px){
    .ctrl-row{grid-template-columns:1fr;align-items:flex-start}
    .badge-row{justify-content:flex-start}
  }
  @media (max-width:700px){
    body{padding:12px}
  }
</style>
</head>
<body>
  <div class="frame">
    <div class="top">
      <div>
        
        <h1>酸の緩衝</h1>
        <div class="chips">
          
        </div>
      </div>
    </div>

    <div class="canvas">
      <div class="chart">
        <div class="grid"></div>
        <div class="bar-wrap">
          <div class="bar">
            <div class="bar-title"><span>陽イオン</span><span style="color:var(--muted)"></span></div>
            <div class="na-stack" aria-label="Na基準"></div>
          </div>
          <div class="bar">
            <div class="bar-title"><span>陰イオン</span><span style="color:var(--muted)"></span></div>
            <div class="stack" aria-label="陰イオンスタック">
              <div class="seg cl" id="segCl"><span>Cl⁻</span></div>
              <div class="seg hco3" id="segHco3"><span>HCO₃⁻</span></div>
              <div class="seg ag" id="segAg"><span>AG</span></div>
              <div class="marker" id="marker">AG</div>
            </div>
          </div>
        </div>
        
        
      </div>

     
    </div>

    <div class="controls" style="margin-top:18px;">
      <div class="ctrl-row">
        <div>
          <label for="acidRange">酸負荷 (mEq/L)</label>
          <input id="acidRange" class="range" type="range" min="0" max="18" step="0.5" value="0" />
          <div class="ticks"><span>0</span><span>9</span><span>18</span></div>
        </div>
       
      </div>
    </div>
  </div>

<script>
  const base = { na:140, cl:104, hco3:24, ag:12 };
  const minHco3 = 6;
  const maxLoad = 18; // HCO3が枯渇しかけるまで

  const $ = (id)=>document.getElementById(id);
  const segCl = $("segCl");
  const segHco3 = $("segHco3");
  const segAg = $("segAg");
  const marker = $("marker");

  function clamp(v,min,max){ return Math.min(max, Math.max(min, v)); }

  function chlorideFraction(acid){
    // 10 mEq/LあたりからCl補填を強めるSカーブ
    const t = clamp(acid, 0, maxLoad);
    const base = Math.pow(t / maxLoad, 1.2) * 0.45;           // 前半の緩やかな上昇
    const surge = t > 10 ? ((t - 10) / (maxLoad - 10)) * 0.45 : 0; // 後半で加速
    return clamp(base + surge, 0, 0.9);                       // 最大でも90%をClで穴埋め
  }

  function compute(acid){
    const buffered = clamp(acid, 0, maxLoad);
    const clPart = buffered * chlorideFraction(buffered);
    const gapPart = buffered - clPart;

    let hco3 = Math.max(minHco3, base.hco3 - buffered);
    let cl = base.cl + clPart;
    let ag = base.ag + gapPart;

    // 電荷バランスが常にNaと一致するよう正規化
    const sum = hco3 + cl + ag;
    const scale = base.na / sum;
    hco3 *= scale;
    cl *= scale;
    ag *= scale;

    return { acid:buffered, hco3, cl, ag, clShare: clPart / buffered || 0 };
  }

  function setWidth(el, pct){
    el.style.flexBasis = pct.toFixed(3) + "%";
  }

  const pct = (v,total)=> (v / total * 100);
  const clampPct = (v,min=0,max=100)=> Math.min(max, Math.max(min, v));

  function describePhase(acid, share){
    if (acid < 2) return "正常域";
    if (share < 0.3) return "AG優位で緩衝";
    if (share < 0.55) return "AG＋Cl混合で代償";
    return "Clによる代償が目立つ";
  }

  function update(){
    const acid = Number($("acidRange").value);
    const { hco3, cl, ag, clShare } = compute(acid);
    const total = cl + hco3 + ag;
    const pctCl = pct(cl, total);
    const pctH = pct(hco3, total);
    const pctAg = 100 - pctCl - pctH; // 合計100%に揃える

    setWidth(segCl, pctCl);
    setWidth(segHco3, pctH);
    setWidth(segAg, pctAg);

    // 棒のラベルはシンプルに名称のみ
    segHco3.querySelector("span").textContent = "HCO₃⁻";
    segCl.querySelector("span").textContent = "Cl⁻";
    segAg.querySelector("span").textContent = "AG";

    $("acidText").textContent = acid.toFixed(1);
    $("agVal").textContent = `${ag.toFixed(1)} (${pctAg.toFixed(1)}%)`;
    $("hco3Val").textContent = `${hco3.toFixed(1)} (${pctH.toFixed(1)}%)`;
    $("clVal").textContent = `${cl.toFixed(1)} (${pctCl.toFixed(1)}%)`;
    $("sumVal").textContent = `${total.toFixed(1)} (100%)`;

    const phase = describePhase(acid, clShare);
    $("phaseText").textContent = phase;

    // マーカー位置（AG開始位置）を視覚化
    const pctAgStart = ((cl + hco3) / total) * 100;
    const safeLeft = clampPct(pctAgStart, 4, 96);
    marker.style.left = safeLeft.toFixed(1) + "%";
    marker.textContent = phase.includes("Cl") ? "Cl補填" : "AG";

    $("note").textContent = phase + "：HCO₃⁻低下と合わせて " +
      (clShare > 0.5 ? "Cl⁻上昇が主体" : "AGの開大が主体") + " に見えます。";
  }

  $("acidRange").addEventListener("input", update);
  update();
</script>
</body>
</html>
