<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Na血症チャート</title>
  <style>
    :root {
      --bg: #0f172a;
      --panel: #111827;
      --accent: #f2c94c;      /* Na系: 黄色 */
      --accent-2: #f59e0b;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --grid: rgba(255,255,255,0.03);
      --card: #1f2937;
      --danger: #f87171;
      --warn: #fbbf24;
      --ok: #34d399;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Segoe UI", "Hiragino Sans", "Yu Gothic", sans-serif;
      color: var(--text);
      background: radial-gradient(120% 80% at 20% 20%, rgba(56,189,248,0.18), transparent),
                  radial-gradient(120% 80% at 80% 30%, rgba(34,211,238,0.12), transparent),
                  var(--bg);
      min-height: 100vh;
      display: grid;
      grid-template-columns: 1.2fr 1fr;
      gap: 16px;
      padding: 18px;
    }
    h1 { margin: 0 0 6px; font-size: 22px; letter-spacing: 0.02em; color: #f8fafc; }
    h2 { margin: 0 0 8px; font-size: 15px; color: #e0f2fe; letter-spacing: 0.02em; }
    .card {
      background: linear-gradient(145deg, #0b1220, #121a2b);
      border: 1px solid rgba(255,255,255,0.04);
      border-radius: 14px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.35);
      padding: 14px;
    }
    .map-card { display: flex; flex-direction: column; gap: 10px; }
    .map-area {
      position: relative;
      height: clamp(320px, 65vh, 520px);
      border-radius: 12px;
      overflow: hidden;
      touch-action: none;
      user-select: none;
      -webkit-user-select: none;
    }
    .map-area * { user-select: none; -webkit-user-select: none; }
    .grid {
      position: absolute; inset: 0;
      background-image:
        linear-gradient(to right, var(--grid) 1px, transparent 1px),
        linear-gradient(to bottom, var(--grid) 1px, transparent 1px);
      background-size: calc(100% / 20) calc(100% / 20);
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.04);
    }
    .cut-lines { position: absolute; inset: 0; pointer-events: none; }
    .v-line, .h-line {
      position: absolute; opacity: 0.6;
      background: linear-gradient(to bottom, transparent, rgba(255,255,255,0.5), transparent);
    }
    .v-line { top: 0; bottom: 0; width: 2px; }
    .h-line { left: 0; right: 0; height: 2px; background: linear-gradient(to right, transparent, rgba(255,255,255,0.5), transparent); }
    .cut-label {
      position: absolute;
      background: rgba(0,0,0,0.55);
      border: 1px solid rgba(255,255,255,0.14);
      color: #e0f2fe;
      padding: 4px 8px;
      border-radius: 8px;
      font-size: 11px;
      transform: translate(-50%, -50%);
      backdrop-filter: blur(6px);
      white-space: nowrap;
    }
    .zone {
      position: absolute;
      color: rgba(255,255,255,0.65);
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 8px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.04);
      backdrop-filter: blur(4px);
      pointer-events: none;
    }
    .axis-label {
      position: absolute;
      color: var(--muted);
      font-size: 12px;
      letter-spacing: 0.03em;
      display: flex;
      gap: 6px;
      align-items: center;
      z-index: 3;
      white-space: nowrap;
    }
    .axis-x { bottom: 6px; left: 50%; transform: translate(-50%, 0); }
    .axis-y { top: 50%; left: 10px; writing-mode: vertical-rl; transform: translate(0, -50%); }
    .person {
      position: absolute;
      width: 68px;
      height: 120px;
      cursor: grab;
      transform: translate(-50%, -50%);
      z-index: 2;
      touch-action: none;
    }
    .person:active { cursor: grabbing; }
    .avatar-label { 
      position: absolute; 
      top: 10px; 
      right: 10px; 
      padding: 6px 10px; 
      background: rgba(0,0,0,0.6); 
      border: 1px solid rgba(255,255,255,0.18); 
      border-radius: 10px; 
      font-size: 12px; 
      color: #e0f2fe; 
      z-index: 4; 
      pointer-events: none; 
      white-space: nowrap; 
      backdrop-filter: blur(6px); 
    } 
    .badge {
      display: inline-flex; align-items: center; gap: 6px;
      padding: 6px 10px; border-radius: 999px; font-size: 12px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.08);
      margin: 2px 6px 6px 0;
    }
    .legend { display: flex; flex-wrap: wrap; align-items: center; gap: 6px; font-size: 12px; color: var(--muted); }
    .dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; }
    .dot-high { background: var(--danger); }
    .dot-low { background: var(--warn); }
    .dot-euvo { background: var(--ok); }
    .status-main { font-size: 17px; margin: 2px 0 6px; color: #fef9c3; }
    .state-grid { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 10px; }
    .state-card { background: var(--card); border: 1px solid rgba(255,255,255,0.06); border-radius: 10px; padding: 10px; min-height: 120px; }
    .small { font-size: 12px; color: var(--muted); margin-bottom: 6px; }
    .pill { display: inline-block; padding: 4px 8px; border-radius: 8px; font-size: 12px; margin: 2px 6px 2px 0; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.06); }
    .intervention { display: grid; gap: 8px; }
    .bars { display: grid; gap: 10px; }
    .bar-block { background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.06); border-radius: 10px; padding: 8px 10px; }
    .bar-label { display: flex; justify-content: space-between; font-size: 12px; color: var(--muted); margin-bottom: 6px; }
    .bar-wrap { position: relative; height: 24px; }
    .bar-track { position: absolute; left: 0; right: 0; top: 4px; height: 16px; border-radius: 8px; background: rgba(255,255,255,0.08); overflow: hidden; z-index: 0; }
    .bar-fill { position: absolute; inset: 0 0 0 0; width: 0; background: linear-gradient(90deg, var(--accent), var(--accent-2)); border-radius: 8px; transition: width 0.15s ease, left 0.15s ease; z-index: 1; }
    .track-vol .bar-fill { background: linear-gradient(90deg, #9be7ff, #38bdf8); }
    .range-rail { position: absolute; inset: 0; border-radius: 999px; pointer-events: none; z-index: 2; }
    .range-tick { position: absolute; top: -4px; width: 2px; height: 24px; background: rgba(255,255,255,0.75); border-radius: 2px; z-index: 3; }
    .tick-label { position: absolute; top: 16px; transform: translateX(-50%); font-size: 11px; color: #e5e7eb; white-space: nowrap; z-index: 3; }
    .state-meta { display: flex; flex-wrap: wrap; gap: 6px; margin: 8px 0; }
    @media (max-width: 1000px) {
      body { grid-template-columns: 1fr; padding: 14px; }
      .map-area { height: clamp(320px, 60vh, 460px); }
      .legend { gap: 4px; }
    }
    @media (max-width: 640px) {
      h1 { font-size: 18px; }
      h2 { font-size: 14px; }
      .card { padding: 12px; }
      .state-grid { grid-template-columns: 1fr; }
      .axis-label { font-size: 11px; }
      .cut-label, .zone { font-size: 11px; }
      .person { width: 60px; height: 130px; }
      .map-area { height: 340px; }
    }
  </style>
</head>
<body>
  <div class="card map-card">
    <h1>Na血症チャート</h1>
    
    <div class="map-area" id="mapArea">
      <div class="grid" id="grid"></div>
      <div class="cut-lines">
        <div class="v-line" style="left:36.36%;"></div>
        <div class="v-line" style="left:54.55%;"></div>
        <div class="h-line" style="top:37.5%;"></div>
        <div class="h-line" style="top:62.5%;"></div>
        
    
      </div>
      <div class="axis-label axis-x">血清Na濃度</div>
      <div class="axis-label axis-y">体液量</div>
      <svg class="person" id="person" viewBox="0 0 80 140"> 
        <defs> 
          <clipPath id="torsoClip"> 
            <rect id="torsoRect" x="15" y="26" width="50" height="90" rx="10" ry="10"/> 
          </clipPath> 
        </defs>
        <circle id="head" cx="40" cy="10" r="15" fill="#cfd2d8"/>
        <rect id="torsoBase" x="15" y="26" width="50" height="90" rx="10" ry="10" fill="#d1d5db"/>
        
        
        <path id="waterPath" clip-path="url(#torsoClip)" fill="#38bdf8" opacity="0.92"></path>
        <rect id="torsoStroke" x="15" y="26" width="50" height="90" rx="10" ry="10" fill="none" stroke="#94a3b8" stroke-width="2"/> 
      </svg> 
      <div class="avatar-label" id="avatarLabel">正常域</div> 
    </div>
    <div class="bars">
      <div class="bar-block"> 
        <div class="bar-label"><span>血清Na</span><span id="naBarVal">140 mEq/L</span></div> 
        <div class="bar-wrap"> 
          <div class="bar-track track-na"> 
            <div class="bar-fill" id="naBarFill"></div> 
          </div> 
          <div class="range-rail"> 
            <div class="range-tick" style="left:36.36%;"></div>  
            <div class="range-tick" style="left:54.54%;"></div>  
             
             
           
          </div> 
        </div> 
      </div> 
      <div class="bar-block"> 
        <div class="bar-label"><span>体液量</span><span id="volBarVal">ほぼ正常</span></div> 
        <div class="bar-wrap"> 
          <div class="bar-track track-vol"> 
            <div class="bar-fill" id="volBarFill"></div> 
          </div> 
          <div class="range-rail"> 
            <div class="range-tick" style="left:35%;"></div>  
            <div class="range-tick" style="left:65%;"></div>  
              
          </div> 
        </div> 
      </div> 
    </div>
    
  </div> 

  <script> 
    const person = document.getElementById('person'); 
    const mapArea = document.getElementById('mapArea'); 
    const naBarFill = document.getElementById('naBarFill'); 
    const naBarVal = document.getElementById('naBarVal'); 
    const volBarFill = document.getElementById('volBarFill'); 
    const volBarVal = document.getElementById('volBarVal'); 
    const head = document.getElementById('head'); 
    const waterPath = document.getElementById('waterPath'); 
    const torsoStroke = document.getElementById('torsoStroke'); 
    const avatarLabel = document.getElementById('avatarLabel'); 

    const presets = {
      hypo: {
        label: "低Na血症",
        urine: ["尿浸透圧: <100 → 水中毒/心因性多飲", "尿Na: <20 → 腎外Na喪失 (嘔吐/下痢/第三間隙)", "尿Na: ≧30 → 腎性喪失 or SIADH"],
        tx: ["まず症候評価：痙攣・意識障害なら高張食塩水(3%) 100mLを10分で", "脱水なら等張液で補正（Naを急速に上げない）", "SIADHなら水制限±高張食塩水＋ループ利尿"],
        monitor: ["Na補正速度: 8-10 mEq/L/日以内", "頻回採血（2-4h毎）、尿量・尿Na/浸透圧を並行チェック"]
      },
      hyper: {
        label: "高Na血症",
        urine: ["尿浸透圧: >800 → 不感蒸泄/Na負荷", "尿浸透圧: <300 → 尿崩症を考慮", "尿Na: 低値なら腎外喪失、高値なら腎性"],
        tx: ["水欠乏なら自由水補正（5%Glu、経口）、ゆっくり補正", "体液過剰＋Na負荷なら利尿薬+低Na輸液", "中枢性尿崩症はデスモプレシンも検討"],
        monitor: ["Na補正速度: 10-12 mEq/L/日以内", "水分出納、尿量(ml/kg/h)、体重・血糖・血ガスを観察"]
      },
      euvo: {
        label: "ほぼ正常域",
        urine: ["尿浸透圧: 300-800 (参考)", "尿量: 0.5-1 mL/kg/h 目安"],
        tx: ["維持輸液: 1-1.5 mL/kg/h 等張液目安", "リスク: 薬剤性低Na（利尿薬/抗うつ薬等）を念のため確認"],
        monitor: ["バイタル・電解質の定期チェック", "水分バランス・体重の推移を確認"]
      }
    };

    function clamp(v, min, max) { return Math.min(max, Math.max(min, v)); }

    function classify(na, vol) {
      const volumeState = vol > 15 ? "過剰" : vol < -15 ? "減少" : "ほぼ正常";
      let bucket = "euvo";
      if (na < 135) bucket = "hypo";
      if (na > 145) bucket = "hyper";
      let nuance = "";
      if (bucket === "hypo") {
        if (volumeState === "減少") nuance = "低張性脱水";
        else if (volumeState === "過剰") nuance = "希釈性低Na";
        else nuance = "SIADH";
      } else if (bucket === "hyper") {
        if (volumeState === "減少") nuance = "脱水/尿崩症";
        else if (volumeState === "過剰") nuance = "塩中毒";
        else nuance = "高Na血症";
      } else {
        if (volumeState === "減少") nuance = "脱水";
        else if (volumeState === "過剰") nuance = "体液過剰";
        else nuance = "基準域";
      }
      return { bucket, volumeState, nuance };
    }

    function render(na, vol) { 
      const { bucket, volumeState, nuance } = classify(na, vol); 
      const px = (na - 115) / (170 - 115); 
      const py = 0.5 - (vol / 120); 
      const rect = mapArea.getBoundingClientRect(); 
      const x = clamp(px * rect.width, 16, rect.width - 16); 
      const y = clamp(py * rect.height, 16, rect.height - 16); 
      person.style.left = `${x}px`; 
      person.style.top = `${y}px`; 
      naBarVal.textContent = `${na} mEq/L`; 
      volBarVal.textContent = volumeState; 
      updateBars(na, vol); 
      updateAvatar(na, vol); 
      avatarLabel.textContent = labelSummary(bucket, volumeState, nuance); 
    } 

    function colorTone(bucket) { 
      person.style.filter = "none"; 
    } 

    function updateAvatar(na, vol) { 
      const torsoX = 15; 
      const torsoY = 26; 
      const torsoW = 50; 
      const torsoH = 90;
      const fillRatio = clamp((vol + 50) / 100, 0.12, 0.95);
      const levelY = torsoY + torsoH * (1 - fillRatio);
      const bottomY = torsoY + torsoH;
      const amp = 6;
      const leftX = torsoX;
      const rightX = torsoX + torsoW;
      const midX = torsoX + torsoW / 2;
      const q1X = torsoX + torsoW / 3;
      const crestY = levelY - amp;
      const d = [
        `M ${leftX} ${levelY.toFixed(1)}`,
        `Q ${q1X.toFixed(1)} ${crestY.toFixed(1)} ${midX.toFixed(1)} ${levelY.toFixed(1)}`,
        `T ${rightX.toFixed(1)} ${levelY.toFixed(1)}`,
        `L ${rightX.toFixed(1)} ${bottomY}`,
        `L ${leftX} ${bottomY} Z`
      ].join(' ');
      waterPath.setAttribute('d', d);

      const lightness = clamp(78 - ((na - 115) / (170 - 115)) * 36, 38, 78);
      const color = `hsl(45, 85%, ${lightness}%)`; // Naバーと連動した黄系 
      head.setAttribute('fill', '#cfd2d8'); 
      waterPath.setAttribute('fill', color); 
      torsoStroke.setAttribute('stroke', '#94a3b8'); 
    } 

    function labelSummary(bucket, volumeState, nuance) {
      // まとめ表示: 主要ラベル + 機序括弧書き
      if (bucket === "hypo") {
        if (volumeState === "過剰") return "希釈性低Na";
        if (volumeState === "減少") return "低張性脱水（Na喪失＞H2O喪失）";
        return "SIADH";
      }
      if (bucket === "hyper") {
        if (volumeState === "過剰") return "塩中毒";
        if (volumeState === "減少") return "脱水（H2O喪失＞Na喪失）";
        return "高Na血症";
      }
      if (bucket === "euvo") {
        if (volumeState === "過剰") return "体液過剰";
        if (volumeState === "減少") return "軽度脱水";
        return "正常";
      }
      return nuance;
    }

    function updateBars(na, vol) {  
      const naRawPercent = clamp(((na - 115) / (170 - 115)) * 100, 0, 100);  
      const naPercent = 20 + naRawPercent * 0.6; // 最小20%残し、最大80%  
      naBarFill.style.width = `${naPercent}%`;  

      const volRaw = clamp((vol + 50) / 100 * 100, 0, 100); // -50〜+50 -> 0〜100  
      const volPercent = 20 + volRaw * 0.6; // 最小20%、最大80%  
      volBarFill.style.width = `${volPercent}%`;  
      volBarFill.style.left = '0%';  
    }  

    let dragging = false;

    function applyPointer(e) {
      const rect = mapArea.getBoundingClientRect();
      const x = clamp(e.clientX - rect.left, 0, rect.width);
      const y = clamp(e.clientY - rect.top, 0, rect.height);
      const na = Math.round(115 + (x / rect.width) * (170 - 115));
      const vol = Math.round((0.5 - y / rect.height) * 120);
      render(na, vol);
    }

    person.addEventListener("pointerdown", (e) => {
      dragging = true;
      person.setPointerCapture(e.pointerId);
    });

    mapArea.addEventListener("pointerdown", (e) => {
      dragging = true;
      mapArea.setPointerCapture(e.pointerId);
      applyPointer(e);
    });

    window.addEventListener("pointermove", (e) => {
      if (!dragging) return;
      applyPointer(e);
    });

    window.addEventListener("pointerup", () => {
      dragging = false;
    });

    // initial render
    render(140, 0);
  </script>
</body>
</html>
